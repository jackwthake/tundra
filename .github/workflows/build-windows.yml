name: Windows

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DSDL_SHARED=ON `
          -DSDL_STATIC=OFF `
          -DSHADER_WORKS_USE_THREADS=ON `
          -DSHADER_WORKS_BUILD_EXAMPLES=OFF

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test Run Program
      run: |
        # Run the program for 10 seconds and capture output
        $job = Start-Job -ScriptBlock { & ".\build\Release\tundra.exe" }
        Start-Sleep -Seconds 10
        Stop-Job $job
        Receive-Job $job > program_output.log 2>&1
        Remove-Job $job

        Write-Host "=== Program Output ==="
        if (Test-Path "program_output.log") {
          Get-Content "program_output.log"
        } else {
          Write-Host "No output captured"
        }
        Write-Host "======================"

    - name: Upload Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: tundra-windows-x64
        path: |
          build/Release/tundra.exe
          build/Release/*.dll
          program_output.log