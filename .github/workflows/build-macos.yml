name: macOS

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew update
        brew install cmake

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DSDL_SHARED=ON \
          -DSDL_STATIC=OFF \
          -DSHADER_WORKS_USE_THREADS=ON \
          -DSHADER_WORKS_BUILD_EXAMPLES=OFF

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test Run Program
      run: |
        # Run the program for 10 seconds and capture output
        timeout 10s ./build/tundra > program_output.log 2>&1 || echo "Program completed or timed out"

        echo "=== Program Output ==="
        if [ -f "program_output.log" ]; then
          cat program_output.log
        else
          echo "No output captured"
        fi
        echo "======================"

    - name: Create App Bundle (optional)
      run: |
        mkdir -p Tundra.app/Contents/MacOS
        mkdir -p Tundra.app/Contents/Frameworks
        cp build/tundra Tundra.app/Contents/MacOS/
        cp build/lib*.dylib Tundra.app/Contents/Frameworks/ || true
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleExecutable</key>
          <string>tundra</string>
          <key>CFBundleIdentifier</key>
          <string>com.example.tundra</string>
          <key>CFBundleName</key>
          <string>Tundra</string>
          <key>CFBundleVersion</key>
          <string>1.0</string>
        </dict>
        </plist>' > Tundra.app/Contents/Info.plist

    - name: Upload macOS Build
      uses: actions/upload-artifact@v4
      with:
        name: tundra-macos-universal
        path: |
          build/tundra
          build/lib*.dylib
          Tundra.app/
          program_output.log